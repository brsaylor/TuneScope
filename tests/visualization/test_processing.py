import numpy as np

from tunescope.visualization.processing import log_axis


def test_log_axis():
    input_spectra = np.array([
        # 0  1  2  3  4  5  6  7  8    # bin = frequency multiple
        [ 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0 ],
        [ 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5 ],
    ], dtype=np.float32)

    output_spectra = log_axis(input_spectra)

    # All energy should be conserved
    assert np.allclose(input_spectra.sum(axis=1), output_spectra.sum(axis=1))

    # Energy should be exponentially increasing with a constant, positive exponent
    # (it is uniform on a linear spectrum)
    # Don't check the first and last bins; the boundaries interfere and they
    # don't matter
    ratios = output_spectra[:,1:] / output_spectra[:,:-1]
    assert ratios[0,1] > 1
    assert np.allclose(ratios[:, 1:-1], ratios[0,1])

    expected_output_spectra = np.array([
        [ 1.36197281,  0.29815662,  0.40128887,  0.54009485, 0.72691393,
          0.97835326,  1.31676626,  1.77223539,  1.60421801],
        [ 0.6809864 ,  0.14907831,  0.20064443,  0.27004743,  0.36345696,
          0.48917663,  0.65838313,  0.8861177 ,  0.802109  ]], dtype=np.float32)

    assert np.allclose(output_spectra, expected_output_spectra)


def test_log_axis_with_expected_data_for_refactoring():
    input_spectra = np.array([
        [1.0],
        [0.5],
    ], dtype=np.float32).repeat(257, axis=1)

    output_spectra = log_axis(input_spectra)

    expected_output_spectra = np.array(
        [[ 1.48918605, 0.02174622, 0.02222431, 0.02271295, 0.02321219, 0.02372254,
           0.02424395, 0.02477705, 0.02532172, 0.02587831, 0.0264473 , 0.0270288,
           0.02762282, 0.02823019, 0.02885079, 0.02948499, 0.03013325, 0.03079569,
           0.03147268, 0.03216457, 0.03287172, 0.03359425, 0.03433287, 0.0350877,
           0.03585899, 0.03664732, 0.03745306, 0.03827631, 0.03911781, 0.03997779,
           0.04085672, 0.04175484, 0.04267275, 0.04361081, 0.04456973, 0.04554939,
           0.04655099, 0.04757404, 0.04862022, 0.04968882, 0.05078125, 0.05189776,
           0.0530386 , 0.05420446, 0.05539632, 0.05661416, 0.05785847, 0.05913067,
           0.06043053, 0.061759  , 0.06311679, 0.06450438, 0.06592226, 0.06737161,
           0.06885266, 0.07036638, 0.07191348, 0.0734942 , 0.07510996, 0.07676101,
           0.07844877, 0.08017325, 0.08193564, 0.08373713, 0.08557796, 0.08745956,
           0.08938169, 0.09134722, 0.09335518, 0.09540701, 0.09750509, 0.09964848,
           0.10183907, 0.10407782, 0.10636616, 0.10870409, 0.11109447, 0.11353636,
           0.11603212, 0.1185832 , 0.12119007, 0.12385464, 0.1265769 , 0.1293602,
           0.13220358, 0.1351099 , 0.1380806 , 0.14111567, 0.14421844, 0.14738846,
           0.15062904, 0.1539402 , 0.15732431, 0.16078329, 0.16431761, 0.16793013,
           0.17162228, 0.17539501, 0.17925072, 0.1831913 , 0.18721867, 0.19133377,
           0.19554138, 0.19983959, 0.20423222, 0.20872307, 0.2133112 , 0.21800041,
           0.22279263, 0.22769165, 0.23269653, 0.23781204, 0.24304008, 0.24838352,
           0.25384331, 0.25942421, 0.26512718, 0.27095604, 0.27691269, 0.28299999,
           0.28922176, 0.29557991, 0.30207825, 0.30871868, 0.31550503, 0.32244205,
           0.32953072, 0.33677483, 0.34417725, 0.35174561, 0.359478  , 0.36738014,
           0.37545586, 0.38371086, 0.39214706, 0.40076637, 0.40957832, 0.41858101,
           0.42778397, 0.4371891 , 0.44679832, 0.45662308, 0.46665955, 0.47691917,
           0.48740387, 0.49811935, 0.50906944, 0.52026176, 0.53169823, 0.54338646,
           0.55533218, 0.56754303, 0.58001709, 0.59276962, 0.60580063, 0.61911964,
           0.63272858, 0.64663887, 0.66085625, 0.67538261, 0.69023132, 0.70540619,
           0.72091293, 0.73675919, 0.75295639, 0.76951218, 0.78642654, 0.80371857,
           0.82138443, 0.83944321, 0.85789871, 0.87675476, 0.89603424, 0.91572952,
           0.93586349, 0.95643234, 0.97746277, 0.99895096, 1.02091217, 1.04335403,
           1.06629181, 1.08973312, 1.11368942, 1.13817596, 1.16319275, 1.18876648,
           1.21490097, 1.24160767, 1.26890564, 1.29679871, 1.32530975, 1.3544426,
           1.38422394, 1.41464996, 1.44574738, 1.47753906, 1.51000977, 1.54321289,
           1.57714081, 1.61180878, 1.64724731, 1.68345642, 1.72046661, 1.75828552,
           1.79694366, 1.83644867, 1.8768158 , 1.91808319, 1.96024323, 2.00334167,
           2.04737854, 2.09239197, 2.13838959, 2.18540192, 2.23344421, 2.282547,
           2.33272552, 2.38400269, 2.43641663, 2.4899826 , 2.54471588, 2.60066223,
           2.65783691, 2.71626282, 2.77597809, 2.83700562, 2.89936829, 2.96311951,
           3.02825928, 3.09481812, 3.16287231, 3.23239136, 3.30345154, 3.37608337,
           3.45030212, 3.52615356, 3.60366821, 3.68289185, 3.76387024, 3.84660339,
           3.9311676 , 4.01757812, 4.10591125, 4.19618225, 4.28842163, 4.38270569,
           4.47904968, 4.57751465, 4.67816162, 4.7809906 , 4.88609314, 4.99351501,
           5.103302  , 5.21548462, 5.33013916, 5.4473114 , 3.26686096],
         [ 0.74459302, 0.01087311, 0.01111215, 0.01135647, 0.0116061 , 0.01186126,
           0.01212198, 0.01238853, 0.01266086, 0.01293916, 0.01322365, 0.0135144,
           0.01381141, 0.0141151 , 0.0144254 , 0.01474249, 0.01506662, 0.01539785,
           0.01573634, 0.01608229, 0.01643586, 0.01679713, 0.01716644, 0.01754385,
           0.01792949, 0.01832366, 0.01872653, 0.01913816, 0.01955891, 0.01998889,
           0.02042836, 0.02087742, 0.02133638, 0.02180541, 0.02228487, 0.0227747,
           0.02327549, 0.02378702, 0.02431011, 0.02484441, 0.02539062, 0.02594888,
           0.0265193 , 0.02710223, 0.02769816, 0.02830708, 0.02892923, 0.02956533,
           0.03021526, 0.0308795 , 0.03155839, 0.03225219, 0.03296113, 0.0336858,
           0.03442633, 0.03518319, 0.03595674, 0.0367471 , 0.03755498, 0.0383805,
           0.03922439, 0.04008663, 0.04096782, 0.04186857, 0.04278898, 0.04372978,
           0.04469085, 0.04567361, 0.04667759, 0.0477035 , 0.04875255, 0.04982424,
           0.05091953, 0.05203891, 0.05318308, 0.05435205, 0.05554724, 0.05676818,
           0.05801606, 0.0592916 , 0.06059504, 0.06192732, 0.06328845, 0.0646801,
           0.06610179, 0.06755495, 0.0690403 , 0.07055783, 0.07210922, 0.07369423,
           0.07531452, 0.0769701 , 0.07866216, 0.08039165, 0.0821588 , 0.08396506,
           0.08581114, 0.08769751, 0.08962536, 0.09159565, 0.09360933, 0.09566689,
           0.09777069, 0.0999198 , 0.10211611, 0.10436153, 0.1066556 , 0.10900021,
           0.11139631, 0.11384583, 0.11634827, 0.11890602, 0.12152004, 0.12419176,
           0.12692165, 0.1297121 , 0.13256359, 0.13547802, 0.13845634, 0.1415,
           0.14461088, 0.14778996, 0.15103912, 0.15435934, 0.15775251, 0.16122103,
           0.16476536, 0.16838741, 0.17208862, 0.1758728 , 0.179739  , 0.18369007,
           0.18772793, 0.19185543, 0.19607353, 0.20038319, 0.20478916, 0.2092905,
           0.21389198, 0.21859455, 0.22339916, 0.22831154, 0.23332977, 0.23845959,
           0.24370193, 0.24905968, 0.25453472, 0.26013088, 0.26584911, 0.27169323,
           0.27766609, 0.28377151, 0.29000854, 0.29638481, 0.30290031, 0.30955982,
           0.31636429, 0.32331944, 0.33042812, 0.33769131, 0.34511566, 0.35270309,
           0.36045647, 0.36837959, 0.3764782 , 0.38475609, 0.39321327, 0.40185928,
           0.41069221, 0.4197216 , 0.42894936, 0.43837738, 0.44801712, 0.45786476,
           0.46793175, 0.47821617, 0.48873138, 0.49947548, 0.51045609, 0.52167702,
           0.5331459 , 0.54486656, 0.55684471, 0.56908798, 0.58159637, 0.59438324,
           0.60745049, 0.62080383, 0.63445282, 0.64839935, 0.66265488, 0.6772213,
           0.69211197, 0.70732498, 0.72287369, 0.73876953, 0.75500488, 0.77160645,
           0.7885704 , 0.80590439, 0.82362366, 0.84172821, 0.86023331, 0.87914276,
           0.89847183, 0.91822433, 0.9384079 , 0.9590416 , 0.98012161, 1.00167084,
           1.02368927, 1.04619598, 1.06919479, 1.09270096, 1.11672211, 1.1412735,
           1.16636276, 1.19200134, 1.21820831, 1.2449913 , 1.27235794, 1.30033112,
           1.32891846, 1.35813141, 1.38798904, 1.41850281, 1.44968414, 1.48155975,
           1.51412964, 1.54740906, 1.58143616, 1.61619568, 1.65172577, 1.68804169,
           1.72515106, 1.76307678, 1.80183411, 1.84144592, 1.88193512, 1.9233017,
           1.9655838 , 2.00878906, 2.05295563, 2.09809113, 2.14421082, 2.19135284,
           2.23952484, 2.28875732, 2.33908081, 2.3904953 , 2.44304657, 2.49675751,
           2.551651  , 2.60774231, 2.66506958, 2.7236557 , 1.63343048]]
        , dtype=np.float32)

    assert np.allclose(output_spectra, expected_output_spectra)
